---
title: "Negative Binomial Simulation Study"
author: "Susanna Makela"
date: "September 19, 2016"
output: html_document
---

We're using the negative binomial to model the distribution of cluster sizes for unsampled clusters. How well does it actually predict the missing sizes under PPS sampling? This is a small simulation study to find out.

Note to self: add bibliography and Patil/Rao citation.

Let's first simulate a population of clusters and see how well Stan can recover the true population parameters and simulate the nonsampled cluster sizes.
```{r, warning = FALSE}
library(ggplot2)
library(rstan)
library(shinystan)
source("src/rspps.r")
source("src/negbin_sim.R")
J <- 100 # number of clusters in pop
K <- 10 # number of clusters to sample
k <- 200
p <- 0.2
Nj.pop <- rnbinom(n = J, size = k, prob = p)
m <- (1 - p) * k / p
v <- (1 - p) * k / p^2
stan.model <- stan_model(file = "src/negbin.stan")
n.iter <- 1000
n.chains <- 4
n.sims <- 500
sim.res <- negbin_sim(Nj.pop, J, K, stan.model, n.iter, n.chains, n.sims)
```

Here's a histogram of the cluster sizes:
```{r, echo = FALSE, warning = FALSE}
pop.data <- data.frame(ids = c(1:J), Nj.pop)
ggplot(pop.data, aes(x = Nj.pop)) +
  geom_histogram() +
  xlab("Population cluster sizes") +
  ylab("Count") +
  theme_bw()
```

Here's the stan model we fit to our data:
```{r, engine = "bash", comment = "", echo = FALSE}
cat src/negbin.stan
```

Patil and Rao's paper (CITE HERE) says that if the distribution of cluster sizes in the population is $NegBin(k, p)$, then the distribution of the nonsampled cluster sizes is $NegBin(k+1, p)$. Let's see if that's true.

Let's make a density plot of the nonsampled cluster sizes and see how the posterior predictive samples compare.
```{r}
# Plot density of true nonsampled cluster sizes vs the simulated ones
Nj.sims <- sim.res[["Nj.sims"]]
ggplot(Nj.sims, aes(x = Nj)) +
  geom_line(stat = "density", aes(group = simno, colour = "Posterior samples")) +
  geom_line(data = pop.data, aes(x = Nj.pop, colour = "Population sizes"),
            stat = "density", size = 1.5) +
  geom_line(data = Nj.sims[Nj.sims$simno == 0, ],
            aes(x = Nj, colour = "Missing sizes"), stat = "density", size = 1.5) +
  scale_colour_manual("",
                      values = c("Posterior samples" = "grey80",
                                 "Population sizes" = "grey50",
                                 "Missing sizes" = "black")) +
  xlab("Cluster size") +
  ylab("Density") +
  theme_bw()
```

The densities seem reasonably well-matched. Let's see how well the model captures the min, max, mean, median, and quartiles of the nonsampled cluster sizes.
```{r, echo = FALSE}
summary.df <- sim.res[["summary.df"]]
ggplot(summary.df, aes(x = value)) +
  geom_histogram() +
  geom_vline(aes(xintercept = truth)) +
  facet_wrap(~ stat, scales = "free") +
  theme_bw()
p.vals <- sim.res[["p.vals"]]
print(p.vals)
```

Hmm... this was just one simulation. How do we know that the results we're seeing aren't a result of the cluster sizes we happened to draw? Let's repeat the above simulation many times and see what the *distribution* of posterior p-values looks like.

```{r, include = FALSE}
n.reps <- 1000
p.vals.df <- data.frame()
for (j in 1:n.reps) {
  res <- negbin_sim(Nj.pop, J, K, stan.model, n.iter, n.chains, n.sims)
  p.vals <- res[["p.vals"]]
  p.vals$rep <- j
  p.vals.df <- rbind(p.vals.df, p.vals)
}
```
```{r, echo = FALSE}
dplyr::summarise(group_by(p.vals.df, stat),
                 mean_pval = mean(p_value))
```
